import java.util.Scanner;

public class BillingSystem {
    private Stock stock;
    private User[] users = new User[10];
    private int userCount = 0;
    
    private User currentUser;
    private Scanner scanner;

    public BillingSystem() {
        stock = new Stock();
        scanner = new Scanner(System.in);
        loadInitialData();
    }

    public Stock getStock() {
        return stock;
    }

    private void loadInitialData() {
        users[userCount++] = new Admin("admin", "admin123");
        users[userCount++] = new Cashier("cashier", "cashier123");

        stock.addProduct(new Product("101", "Milk", 52.50), 100);
        stock.addProduct(new Product("102", "Bread", 40.00), 80);
        stock.addProduct(new TaxableProduct("201", "Laptop", 50000.00, 0.18), 10);
    }

    private boolean handleLogin() {
        System.out.println("\n--- Login ---");
        System.out.print("Username: ");
        String username = scanner.nextLine();
        System.out.print("Password: ");
        String password = scanner.nextLine();

        for (int i = 0; i < userCount; i++) {
            if (users[i].login(username, password)) {
                currentUser = users[i];
                System.out.println("Login Successful. Welcome, " + currentUser.username);
                return true;
            }
        }
        System.out.println("Login Failed! Invalid credentials.");
        return false;
    }

    private void handleLogout() {
        System.out.println("Logging out " + currentUser.username + "...");
        currentUser = null;
    }

    public void adminAddProduct(Scanner scanner) {
        System.out.println("\n--- Add New Product ---");
        System.out.print("Enter Product ID: ");
        String id = scanner.nextLine();
        
        if (stock.getProductById(id) != null) {
            System.out.println("Error: This Product ID already exists.");
            return;
        }
        
        System.out.print("Enter Product Name: ");
        String name = scanner.nextLine();
        System.out.print("Enter Price: ");
        double price = scanner.nextDouble();
        System.out.print("Enter Quantity: ");
        int quantity = scanner.nextInt();
        System.out.print("Is this product taxable? (1=Yes, 0=No): ");
        int choice = scanner.nextInt();
        scanner.nextLine();

        if (choice == 1) {
            System.out.print("Enter Tax Rate (e.g., 0.05 for 5%): ");
            double taxRate = scanner.nextDouble();
            scanner.nextLine();
            stock.addProduct(new TaxableProduct(id, name, price, taxRate), quantity);
        } else {
            stock.addProduct(new Product(id, name, price), quantity);
        }
    }

    public void cashierCreateInvoice(Scanner scanner) {
        System.out.println("\n--- Create New Invoice ---");
        System.out.print("Enter Customer Name: ");
        String custName = scanner.nextLine();
        System.out.print("Enter Customer Contact: ");
        String custContact = scanner.nextLine();

        Invoice invoice = new Invoice(custName, custContact);

        String addMore = "yes";
        
        while (addMore.equals("yes") || addMore.equals("y")) {
            stock.viewStock();
            System.out.print("\nEnter Product ID to add: ");
            String productId = scanner.nextLine();

            Product product = stock.getProductById(productId);
            if (product == null) {
                System.out.println("Error: Invalid Product ID.");
            } else {
                System.out.print("Enter Quantity: ");
                int quantity = scanner.nextInt();
                scanner.nextLine();

                if (!stock.isStockAvailable(productId, quantity)) {
                    System.out.println("Error: Not enough stock.");
                } else {
                    invoice.addItem(product, quantity);
                    stock.decreaseStock(productId, quantity);
                }
            }
            
            System.out.print("Add another item? (yes/no): ");
            addMore = scanner.nextLine();
        }

        System.out.println("Finalizing Invoice...");
        invoice.calculateTotal();
        invoice.printInvoice();
    }

    public void run() {
        while (true) {
            if (currentUser == null) {
                System.out.println("\nWELCOME TO THE SUPERMART BILLING SYSTEM");
                System.out.println("  1. Login");
                System.out.println("  2. Exit");
                System.out.print("Enter your choice: ");
                
                int choice = scanner.nextInt();
                scanner.nextLine();

                if (choice == 1) {
                    handleLogin();
                } else if (choice == 2) {
                    System.out.println("Thank you! Exiting system.");
                    break;
                }
            } else {
                currentUser.showMenu(scanner, this);
                handleLogout();
            }
        }
        scanner.close();
    }

    public static void main(String[] args) {
        BillingSystem supermart = new BillingSystem();
        supermart.run();
    }
}

class Product {
    private String id;
    private String name;
    protected double price;

    public Product(String id, String name, double price) {
        this.id = id;
        this.name = name;
        this.price = price;
    }

    public String getId() { return id; }
    public String getName() { return name; }
    public double getPrice() { return price; }

    public double getFinalPrice(int quantity) {
        return price * quantity;
    }

    public void display() {
        System.out.println(id + "\t" + name + "\t" + price);
    }
}

class TaxableProduct extends Product {
    private double taxRate;

    public TaxableProduct(String id, String name, double price, double taxRate) {
        super(id, name, price);
        this.taxRate = taxRate;
    }

    public double getFinalPrice(int quantity) {
        double basePrice = price * quantity;
        double tax = basePrice * taxRate;
        return basePrice + tax;
    }

    public void display() {
        super.display();
        System.out.println("\t(Tax: " + (taxRate * 100) + "%)");
    }
}

class LineItem {
    private Product product;
    private int quantity;

    public LineItem(Product product, int quantity) {
        this.product = product;
        this.quantity = quantity;
    }

    public Product getProduct() { return product; }
    public int getQuantity() { return quantity; }
}

class Stock {
    protected Product[] productList = new Product[50];
    protected int[] productQuantity = new int[50];
    protected int productCount = 0;

    public void addProduct(Product product, int quantity) {
        if (productCount < productList.length) {
            productList[productCount] = product;
            productQuantity[productCount] = quantity;
            productCount++;
            System.out.println("Product '" + product.getName() + "' added.");
        } else {
            System.out.println("Stock is full. Cannot add more products.");
        }
    }

    public void viewStock() {
        System.out.println("\nCURRENT STOCK");
        System.out.println("ID\tName\tPrice\tQuantity");
        
        for (int i = 0; i < productCount; i++) {
            Product p = productList[i];
            int q = productQuantity[i];
            System.out.print(p.getId() + "\t" + p.getName() + "\t" + p.getPrice() + "\t" + q);
            
            if (p instanceof TaxableProduct) {
                 System.out.println("\t(Taxable)");
            } else {
                 System.out.println();
            }
        }
    }

    public Product getProductById(String id) {
        for (int i = 0; i < productCount; i++) {
            if (productList[i].getId().equals(id)) {
                return productList[i];
            }
        }
        return null;
    }

    public boolean isStockAvailable(String id, int quantity) {
        for (int i = 0; i < productCount; i++) {
            if (productList[i].getId().equals(id)) {
                return productQuantity[i] >= quantity;
            }
        }
        return false;
    }

    public void decreaseStock(String id, int quantity) {
        for (int i = 0; i < productCount; i++) {
            if (productList[i].getId().equals(id)) {
                productQuantity[i] = productQuantity[i] - quantity;
                return;
            }
        }
    }
}

class Invoice {
    private String customerName;
    private String customerContact;
    
    private LineItem[] items = new LineItem[20];
    private int itemCount = 0;
    
    private double subTotal;
    private double totalTax;
    private double grandTotal;

    public Invoice(String name, String contact) {
        this.customerName = name;
        this.customerContact = contact;
    }

    public void addItem(Product product, int quantity) {
        if (itemCount < items.length) {
            items[itemCount] = new LineItem(product, quantity);
            itemCount++;
            System.out.println("Added " + quantity + " x " + product.getName());
        } else {
            System.out.println("Invoice is full. Cannot add more items.");
        }
    }

    public void calculateTotal() {
        subTotal = 0.0;
        grandTotal = 0.0;
        totalTax = 0.0;

        for (int i = 0; i < itemCount; i++) {
            LineItem item = items[i];
            Product product = item.getProduct();
            int quantity = item.getQuantity();

            double basePrice = product.getPrice() * quantity;
            double finalPrice = product.getFinalPrice(quantity);

            subTotal = subTotal + basePrice;
            grandTotal = grandTotal + finalPrice;
            totalTax = totalTax + (finalPrice - basePrice);
        }
    }

    public void printInvoice() {
        System.out.println("\nSUPERMART INC.");
        System.out.println("Bill To: " + customerName);
        System.out.println("Contact: " + customerContact);
        System.out.println("\nItems:");
        System.out.println("Qty\tItem\t\tPrice\tAmount");

        for (int i = 0; i < itemCount; i++) {
            LineItem item = items[i];
            Product p = item.getProduct();
            int q = item.getQuantity();
            
            System.out.println(
                q + "\t" + 
                p.getName() + "\t\t" + 
                p.getPrice() + "\t" + 
                p.getFinalPrice(q)
            );
        }

        System.out.println("\nSubtotal: \t" + subTotal);
        System.out.println("Total Tax: \t" + totalTax);
        System.out.println("GRAND TOTAL: \t" + grandTotal);
        System.out.println("\nThank you for shopping with us!\n");
    }
}

abstract class User {
    protected String username;
    protected String password;

    public User(String username, String password) {
        this.username = username;
        this.password = password;
    }

    public boolean login(String user, String pass) {
        return username.equals(user) && password.equals(pass);
    }

    public abstract void showMenu(Scanner scanner, BillingSystem system);
}

class Admin extends User {
    public Admin(String username, String password) {
        super(username, password);
    }

    public void showMenu(Scanner scanner, BillingSystem system) {
        boolean loggedIn = true;
        while (loggedIn) {
            System.out.println("\n--- ADMIN MENU ---");
            System.out.println("  1. Add New Product");
            System.out.println("  2. View Stock");
            System.out.println("  3. Logout");
            System.out.print("Enter your choice: ");

            int choice = scanner.nextInt();
            scanner.nextLine();

            switch (choice) {
                case 1:
                    system.adminAddProduct(scanner);
                    break;
                case 2:
                    system.getStock().viewStock();
                    break;
                case 3:
                    loggedIn = false;
                    break;
                default:
                    System.out.println("Invalid choice.");
            }
        }
    }
}

class Cashier extends User {
    public Cashier(String username, String password) {
        super(username, password);
    }

    public void showMenu(Scanner scanner, BillingSystem system) {
        boolean loggedIn = true;
        while (loggedIn) {
            System.out.println("\n--- CASHIER MENU ---");
            System.out.println("  1. Create New Invoice");
            System.out.println("  2. Logout");
            System.out.print("Enter your choice: ");

            int choice = scanner.nextInt();
            scanner.nextLine();

            switch (choice) {
                case 1:
                    system.cashierCreateInvoice(scanner);
                    break;
                case 2:
                    loggedIn = false;
                    break;
                default:
                    System.out.println("Invalid choice.");
            }
        }
    }
}
